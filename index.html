<!doctype html>
<html>

    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Camera POS</title>
    <style>
        body { display:flex; margin:0; padding:0; height:100vh; background:white; color:black; }
        #video-container { flex: 0 0 50%; display: flex; justify-content: center; align-items: center; background: white;}
        #cam { width: min(100%, 90vh); height: auto; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; border: 2px solid #333; }
        #pos { flex: 0 0 48%; padding: 5px; overflow: auto; background: white; }
        table { width:100%; border-collapse: collapse; }
        th, td { border:1px solid #555; padding:5px; text-align:left; }
        button { padding:10px 20px; font-size:16px; margin-bottom:10px; }
    </style>
    </head>

    <body>
        <div id="video-container">
            <img id="cam" src="/inference" alt="Camera stream">
        </div>
        <div id="pos" style="font-size: 1.3em; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size:1.5em;">ðŸ›’ Cart:</h2>
            <button onclick="restartTransaction()" style="font-size:1.3em; background-color: red; color: white; border: none; cursor: pointer; border-radius: 4px;">Restart</button>
            </div>
            <table id="pos_table" style="font-size:1.2em; overflow: auto;"></table>
            <!-- <tr><th>Qty</th><th>Name</th><th>Unit Price (â‚±)</th><th>Total Price (â‚±)</th></tr>
            </table> -->
            <h3 style="font-size:1.8em; margin-top: auto;">Grand Total: â‚±<span id="grand_total">0</span></h3>
        </div>

        <audio id="beep_sound" src="/static/beep.mp3"></audio>

        <script>
            let beep_unlocked = false;

            function restartTransaction() {
                fetch('/restart');
                const table = document.getElementById('pos_table');
                table.innerHTML = '<tr><th>Qty</th><th>Name</th><th>Unit Price (â‚±)</th><th>Total Price (â‚±)</th></tr>';
                document.getElementById('grand_total').textContent = '0';
            }

            // Restart transaction only on page refresh (not first load)
            if (performance.navigation.type === 1) {
                restartTransaction();
            }

            if (!beep_unlocked) {
                const beep = document.getElementById('beep_sound');
                beep.play().catch(() => {});
                beep.pause();
                beep.currentTime = 0;
                beep_unlocked = true;
            }

            async function updatePOS() {
                const response = await fetch('/pos_items');
                const data = await response.json();
                const table = document.getElementById('pos_table');

                // Clear table except header
                table.innerHTML = '<tr><th>Qty</th><th>Name</th><th>Unit Price (â‚±)</th><th>Total Price (â‚±)</th></tr>';

                for (const key in data.items) {
                    if (data.items.hasOwnProperty(key)) {
                        const item = data.items[key];
                        const row = table.insertRow();
                        row.insertCell(0).textContent = item.qty;
                        row.insertCell(1).textContent = key;
                        row.insertCell(2).textContent = item.unit_price;
                        row.insertCell(3).textContent = item.total_price;
                    }
                }

                // Update grand total
                document.getElementById('grand_total').textContent = data.grand_total;
                
                // Play beep if new item detected
                if (data.new_item && beep_unlocked) {
                    document.getElementById('beep_sound').play();
                }
            }

            setInterval(updatePOS, 500);
        </script>
    </body>
</html>