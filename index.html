<!doctype html>
<html>

    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Camera POS</title>
    <style>
        body { display:flex; margin:0; padding:0; height:100vh; background:black; color:white; }
        #video-container { flex: 0 0 60%; display: flex; justify-content: center; align-items: center; background: black;}
        #cam { width: min(100%, 90vh); height: auto; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; border: 2px solid #333; }
        #pos { flex: 0 0 40%; padding: 10px; overflow: auto; background: #111; }
        table { width:100%; border-collapse: collapse; }
        th, td { border:1px solid #555; padding:5px; text-align:left; }
        button { padding:10px 20px; font-size:16px; margin-bottom:10px; }
    </style>
    </head>

    <body>
        <div id="video-container">
            <img id="cam" src="/inference" alt="Camera stream">
        </div>
        <div id="pos">
            <button onclick="startInference()">Start</button>
            <h2>Items:</h2>
            <table id="pos_table">
                <tr><th>Qty</th><th>Name</th><th>Unit Price (₱)</th><th>Total Price (₱)</th></tr>
            </table>
            <h3>Grand Total: ₱<span id="grand_total">0</span></h3>
        </div>

        <audio id="beep_sound" src="/static/beep.mp3"></audio>
        <audio id="open_sound" src="/static/discord_join.mp3"></audio>
        <audio id="close_sound" src="/static/discord_leave.mp3"></audio>

        <script>
            let beep_unlocked = false;

            function startInference() {
                fetch('/start');
            }

            if (!beep_unlocked) {
            const beep = document.getElementById('beep_sound');
            const open = document.getElementById('open_sound');
            const close = document.getElementById('close_sound');
            beep.play().catch(() => {});
            beep.pause();
            beep.currentTime = 0;
            open.play().catch(() => {});
            open.pause();
            open.currentTime = 0;
            close.play().catch(() => {});
            close.pause();
            close.currentTime = 0;
            beep_unlocked = true;
            }

            async function pollGestureEvent() {
                const res = await fetch('/gesture_event');
                const data = await res.json();

                if (data.event == "open") {
                    const open_sound = document.getElementById('open_sound');
                    open_sound.currentTime = 0;
                    open_sound.play();
                }
                else if (data.event == "close") {
                    const close_sound = document.getElementById('close_sound');
                    close_sound.currentTime = 0;
                    close_sound.play();
                }
            }

            async function updatePOS() {
                const response = await fetch('/pos_items');
                const data = await response.json();
                const table = document.getElementById('pos_table');

                // Clear table except header
                table.innerHTML = '<tr><th>Qty</th><th>Name</th><th>Unit Price (₱)</th><th>Total Price (₱)</th></tr>';

                // Add items
                for (const item of data.items) {
                const row = table.insertRow();
                row.insertCell(0).textContent = item.qty;
                row.insertCell(1).textContent = item.name;
                row.insertCell(2).textContent = item.unit_price;
                row.insertCell(3).textContent = item.total_price;
                }

                // Update grand total
                document.getElementById('grand_total').textContent = data.grand_total;
                
                // Play beep if new item detected
                if (data.new_item && beep_unlocked) {
                document.getElementById('beep_sound').play();
                }
            }

            setInterval(updatePOS, 500);
            setInterval(pollGestureEvent, 500);
        </script>
    </body>
</html>